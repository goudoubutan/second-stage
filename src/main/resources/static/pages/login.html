<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>登录</title>
    <link rel="shortcut icon" type="image/svg" href="/pages/img/title.svg"/>
    <script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/vue/2.2.2/vue.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/animate.css@3.5.1" rel="stylesheet" type="text/css">
    <!-- 引入样式 -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
<!--  <script src="/js/jquery.min.js"></script>-->
   <link rel="stylesheet" media="screen" href="../css/style.css">
  <style>

    #content{
      width: 400px;;
      margin: 60px auto;
    }
    .title{
      height: 50px;
      border-bottom: 1px solid #e1e7ec;
      text-align: center;
    }
    #content a{
      text-decoration: none;
      color: black;
      font-size: 16px;
      background: #f1f1f1;
      padding: 5px 10px;
      margin: 0 10px;
      border-radius: 5px;
    }
    .form-input{
      height: 46px;
      line-height: 46px;
      margin-top: 10px;;
    }
    input{
      box-sizing: border-box;
      padding: 0 25px;
      background: #e1e4e6;
      border-radius: 8px;
      width: 100%;
      height: 100%;
      border: 0;
      outline: 0;
      font-size: 14px;
    }
    #content .active{
      background-color: #09f;
      color: #fff;
    }
    .primary-button{
      background: linear-gradient(325deg,#4aa4ff,#1058fa);
      width: 100%;
      height: 42px;
      border-radius: 23px;
      border: 0;
      outline: none;
      color: #fff;
      letter-spacing: 10px;
      font-weight: 500;
      font-size: 16px;
      cursor: pointer;
      margin-top: 30px;
    }
    .pic{
      width: 250px;
      height: 250px;
      margin: 0 auto;
    }
    .pic img{
      width: 100%;
      height: 100%;
    }

    #msg {
        position: fixed;
        width: 300px;
        height: auto;
        text-align: center;
        top: 5%;
        left: 85%;
        transform: translate(-50%, -50%);
        z-index: 9999; /* 设置一个较高的 z-index 值以确保在页面最顶层显示 */
    }
  </style>
</head>
<body>

<div role="alert" class="el-alert el-alert--error is-light" id="msg" style="display: none;">
    <div class="el-alert__content"><span class="el-alert__title">错误提示的文案</span>
        <i class="el-alert__closebtn el-icon-close"></i></div></div>

</div>
</div>


<div style="text-align: center;">
  <img class="mb-4" src="/assets/demo.svg" alt="" width="102" height="87" style="margin-top: 40px;">
</div>

  <!-- 定义登录组件 -->
<template id="example1">

  <div> 
   <!-- 唯一的根容器 -->
   <div class="form-input">
     <input type="text" name="phone" id="phone" placeholder="请输入手机号" class="form-input">
   </div>
   <div class="form-input">
       <input type="text" name="code" id="code" placeholder="请输入验证码" class="form-input" style="width: 60%; float: left;">
   <input type="button" id="bt" onclick="sendCode()"  value="免费获取验证码" style="width: 33%;float: right;height: 46px;margin-top: 10px;text-align: center;">

   </div>
   <button type="button" onclick="login()" class="primary-button"><span>登录</span></button>
  </div>
 </template>

 <!-- 二维码登录 -->
 <template id="example2">
   <div class="pic" id="qrcode"></div>
 </template>


 <div id="content">
   <div class="title">
     <a href="javascript:;" @click="compontentName = 'example1',cur=0" :class="{active:cur == 0}">验证码登录</a>
     <a href="javascript:getUrl();" @click="compontentName = 'example2',cur=1" :class="{active:cur == 1}">二维码登录</a>
     <a href="/pages/register.html" @click="compontentName = 'example3',cur=2" :class="{active:cur == 2}">前往注册</a>
   </div>
   <transition enter-active-class="animated bounceInDown">
     <component :is="compontentName"></component>
   </transition>
 </div>
 <script>
  Vue.component('example1',{template:'#example1'})
  Vue.component('example2',{template:'#example2'})
  Vue.component('example3',{template:'#example3'})
  var vm = new Vue({
    el: '#content',
    data: { 
      compontentName :'example1',
      cur:0
      }
  });


  //用户的状态code
  var state;
  function getUrl(){
      $.get(
          "/getWxLoginUrl",
          function(res){
              //获取状态码
              state = res.state;
              //授权地址
              var url = res.url;
              console.log(url);
              var qrcode = new QRCode(document.getElementById("qrcode"));
              qrcode.makeCode(url);
              //轮询验证用户是否登录
              checkUserLogin();
              // window.location.href = "/pages/index.html"
          }
      )
  }

  function checkUserLogin(){
      //发送ajax请求
      $.get(
          "checkLogin?state="+state,
          function(res){
              if(res=="true"){
                  alert("登录成功")
                  window.location.href = "/pages/index.html"
              }else{
                  setTimeout(function(){
                      checkUserLogin();
                  },1000)
              }
          }
      )
  }

var wait = 60;
$("#bt").disabled = false;
function time(o) {
if (wait == 0) {
o.removeAttribute("disabled");
o.value = "免费获取验证码";
wait = 60;
} else {
o.setAttribute("disabled", true);
// $(o).attr("disabled", true);
o.value = wait + "秒后,重新获取";
wait--;
setTimeout(function () {
      time(o)
    },
    1000)
}
}

document.getElementById("bt").onclick =
  function () {
    var phoneRegex = /^[1-9]\d{10}$/;
    if($("#phone").val() == "" || !phoneRegex.test($("#phone").val())){
        $("#msg").show();
        $("#msg").html("请先输入手机号码！");
        // return false;
    }else{
    time(this);
    sendCode()
    }
  }

  function sendCode(){
    $.ajax({
      url:"/sendCode",
      type:"post",
      data:{
        phone:$("#phone").val()
      }
    })
  }

  function login(){
      // 手机号码验证正则表达式
      var phoneRegex = /^[1-9]\d{10}$/;

      if ($("#phone").val().trim() === "" || !phoneRegex.test($("#phone").val())) {
          $("#msg").show();
          $("#msg").html("请输入正确的手机号码！");
          // return false;
      } else {
          $.ajax({
              url: "/LoginByPhone",
              method: "post",
              data: {
                  phone: $("#phone").val(),
                  code: $("#code").val()
              },
              success: function (res){
                  if (res == 0){
                      $("#msg").show();
                      $("#msg").html("验证码错误！");
                  }else if (res == -1){
                      $("#msg").show();
                      $("#msg").html("用户不存在,请先注册！");
                  } else if (res == 1){
                      window.location.href = "/pages/index.html"
                  }
              }
          })
      }
  }


  $("#msg").on("click", function() {
      $("#msg").hide();
  });

</script>   
</body>

<!-- particles.js container -->
<div id="particles-js"></div>
<script src="/js/qrcode.min.js"></script>
<!-- scripts -->
<script src="/js/particles.js"></script>
<script src="/js/app.js"></script>
</body>

<!-- import Vue before Element -->
<script src="https://unpkg.com/vue@2/dist/vue.js"></script>
<script src="https://unpkg.com/element-ui/lib/index.js"></script>

</html>